name: Build Tizen WGT

on:
  push:
    branches: [ "codex/Improved-UI", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TIZEN_SDK: /home/runner/tizen-studio
      PATH: ${{ env.PATH }}:/home/runner/tizen-studio/tools/ide/bin:/home/runner/tizen-studio/tools/cli
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tizen CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          wget https://download.tizen.org/sdk/Installer/tizen-studio_5.5/web-cli_Tizen_Studio_5.5_ubuntu-64.bin -O tizen-cli.bin
          chmod +x tizen-cli.bin
          ./tizen-cli.bin --accept-license --no-java-check "${TIZEN_SDK}"

      - name: Add Tizen CLI to PATH
        run: |
          echo "$HOME/tizen-studio/tools/ide/bin" >> $GITHUB_PATH
          echo "$HOME/tizen-studio/tools/cli" >> $GITHUB_PATH

      - name: Verify Tizen CLI
        run: |
          which tizen
          tizen version

      - name: Setup signing
        env:
          AUTHOR_P12_B64: ${{ secrets.TIZEN_AUTHOR_P12_B64 }}
          AUTHOR_P12_PASSWORD: ${{ secrets.TIZEN_AUTHOR_P12_PASSWORD }}
        run: |
          mkdir -p ~/.tizen
          echo "$AUTHOR_P12_B64" | base64 -d > author.p12
          tizen certificate-author -a "github" -p "$AUTHOR_P12_PASSWORD" -c "$PWD/author.p12"
          tizen security-profiles add -n github-profile -a github

      - name: Build WGT
        run: |
          tizen build-web -t . -o dist
          tizen package -t wgt -s github-profile -o dist -- dist
          ls -la dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizen-wgt
          path: dist/*.wgt
