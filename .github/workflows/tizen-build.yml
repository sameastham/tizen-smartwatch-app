name: Build Tizen WGT

on:
  push:
    branches: [ "codex/Improved-UI", "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      TIZEN_SDK: /home/runner/tizen-studio
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Tizen CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget
          wget https://download.tizen.org/sdk/Installer/tizen-studio_5.5/web-cli_Tizen_Studio_5.5_ubuntu-64.bin -O tizen-cli.bin
          chmod +x tizen-cli.bin
          ./tizen-cli.bin --accept-license --no-java-check "${TIZEN_SDK}"

      - name: Add Tizen CLI to PATH
        run: |
          echo "$TIZEN_SDK/tools/ide/bin" >> $GITHUB_PATH
          echo "$TIZEN_SDK/tools/cli" >> $GITHUB_PATH

      - name: Locate Tizen CLI
        run: |
          CANDIDATE="$(find "$TIZEN_SDK" "$GITHUB_WORKSPACE" -type f -name tizen 2>/dev/null | head -n 1)"
          if [ -z "$CANDIDATE" ]; then
            echo "Tizen CLI not found" >&2
            exit 1
          fi
          chmod +x "$CANDIDATE"
          echo "TIZEN_CLI=$CANDIDATE" >> $GITHUB_ENV

      - name: Verify Tizen CLI
        run: |
          ls -la "$TIZEN_SDK/tools/cli" || true
          ls -la "$TIZEN_SDK/tools/ide/bin" || true
          "$TIZEN_CLI" version

      - name: Setup signing
        env:
          AUTHOR_P12_B64: ${{ secrets.TIZEN_AUTHOR_P12_B64 }}
          AUTHOR_P12_PASSWORD: ${{ secrets.TIZEN_AUTHOR_P12_PASSWORD }}
        run: |
          mkdir -p ~/.tizen
          echo "$AUTHOR_P12_B64" | base64 -d > author.p12
          echo "author.p12 bytes: $(wc -c < author.p12)"
          sha256sum author.p12 | awk '{print "author.p12 sha256:", $1}'
          echo "author password length: ${#AUTHOR_P12_PASSWORD}"
          "$TIZEN_CLI" security-profiles add -n github-profile -a "$PWD/author.p12" -p "$AUTHOR_P12_PASSWORD" -A -f
          "$TIZEN_CLI" cli-config "profiles.path=$HOME/tizen-studio-data/profile/profiles.xml" || true
          "$TIZEN_CLI" security-profiles list || true
          "$TIZEN_CLI" package --help || true

      - name: Build WGT
        run: |
          "$TIZEN_CLI" build-web -- "$GITHUB_WORKSPACE" -out dist || true
          if [ -f "$HOME/tizen-studio-data/cli/logs/cli.log" ]; then
            echo "---- tizen cli log (tail) ----"
            tail -n 200 "$HOME/tizen-studio-data/cli/logs/cli.log"
            echo "------------------------------"
          fi
          if [ ! -d dist ]; then
            echo "Build output missing" >&2
            exit 1
          fi
          set +e
          "$TIZEN_CLI" package -t wgt -s github-profile -o dist -- dist
          PACKAGE_EXIT=$?
          set -e
          if [ -f "$HOME/tizen-studio-data/cli/logs/cli.log" ]; then
            echo "---- tizen cli log after package (tail) ----"
            tail -n 200 "$HOME/tizen-studio-data/cli/logs/cli.log"
            echo "-------------------------------------------"
          fi
          if [ $PACKAGE_EXIT -ne 0 ]; then
            echo "Packaging failed with exit code $PACKAGE_EXIT" >&2
            exit $PACKAGE_EXIT
          fi
          ls -la dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tizen-wgt
          path: dist/*.wgt
